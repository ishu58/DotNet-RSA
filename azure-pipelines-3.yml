trigger:
- main

variables:
- group: vm-credentials
- name: buildConfiguration
  value: 'Release'
- name: serviceConnection
  value: 'myapi-azure-connection'

stages:
- stage: Build
  displayName: Build Artifact
  jobs:
  - job: Build
    pool:
      vmImage: 'windows-latest'
    steps:
    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '6.x'

    - script: dotnet restore DotNet-RSA.sln
      displayName: 'Restore Packages'

    - script: dotnet build --configuration $(buildConfiguration)
      displayName: 'Build Solution'

    - task: DotNetCoreCLI@2
      inputs:
        command: 'publish'
        publishWebProjects: true
        arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)'
        zipAfterPublish: true

    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)'
        artifact: 'drop'

- stage: Test
  displayName: Deploy to Test
  dependsOn: Build
  variables:
    websiteName: 'MyAPI-Test'
  jobs:
  - deployment: TestDeploy
    environment: Test
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: drop
            
          - task: WindowsMachineFileCopy@2
            inputs:
              SourcePath: '$(Pipeline.Workspace)/drop'
              MachineNames: $(vmName)
              AdminUserName: $(vmAdmin)
              AdminPassword: $(vmAdminPassword)
              TargetPath: 'C:\Temp\Deploy'
              
          - task: PowerShell@2
            inputs:
              targetType: 'inline'
              script: |
                $WebSiteName = "$(websiteName)"
                $password = ConvertTo-SecureString -String "$(vmAdminPassword)" -AsPlainText -Force
                $credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList "$(vmAdmin)", $password

                Invoke-Command -ComputerName "$(vmName)" -Credential $credential -ScriptBlock {
                  param($WebSiteName)
                  
                  # Create/clean directory
                  $deployPath = "C:\inetpub\$WebSiteName"
                  if (-not (Test-Path $deployPath)) {
                      New-Item -Path $deployPath -ItemType Directory
                  }
                  else {
                      Get-ChildItem -Path $deployPath | Remove-Item -Recurse -Force
                  }

                  # Extract files
                  Expand-Archive -Path "C:\Temp\Deploy\*.zip" -DestinationPath $deployPath -Force

                  # Configure IIS
                  if (-not (Get-Website -Name $WebSiteName -ErrorAction SilentlyContinue)) {
                      New-Website -Name $WebSiteName -PhysicalPath $deployPath -Port 80
                  }
                  else {
                      Set-ItemProperty "IIS:\Sites\$WebSiteName" -Name physicalPath -Value $deployPath
                  }

                  # Set permissions (optional)
                  icacls $deployPath /grant "IIS AppPool\$WebSiteName:(OI)(CI)(RX)"

                  # Restart website
                  Stop-WebSite -Name $WebSiteName -ErrorAction SilentlyContinue
                  Start-WebSite -Name $WebSiteName
                } -ArgumentList $WebSiteName

- stage: Stage
  displayName: Deploy to Stage
  dependsOn: Test
  condition: succeeded()
  variables:
    websiteName: 'MyAPI-Stage'
  jobs:
  - deployment: StageDeploy
    environment: Stage
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: drop
            
          - task: WindowsMachineFileCopy@2
            inputs:
              SourcePath: '$(Pipeline.Workspace)/drop'
              MachineNames: $(vmName)
              AdminUserName: $(vmAdmin)
              AdminPassword: $(vmAdminPassword)
              TargetPath: 'C:\Temp\Deploy'
              
          - task: PowerShell@2
            inputs:
              targetType: 'inline'
              script: |
                # Same script as Test stage with different $websiteName
                # ...

- stage: Prod
  displayName: Deploy to Prod
  dependsOn: Stage
  condition: succeeded()
  variables:
    websiteName: 'MyAPI-Prod'
  jobs:
  - deployment: ProdDeploy
    environment: Prod
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: drop
            
          - task: WindowsMachineFileCopy@2
            inputs:
              SourcePath: '$(Pipeline.Workspace)/drop'
              MachineNames: $(vmName)
              AdminUserName: $(vmAdmin)
              AdminPassword: $(vmAdminPassword)
              TargetPath: 'C:\Temp\Deploy'
              
          - task: PowerShell@2
            inputs:
              targetType: 'inline'
              script: |
                # Same script as Test stage with different $websiteName
                # ...